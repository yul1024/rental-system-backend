# 婚纱店后端

## 技术栈
- python fastapi
- mysql

## 项目结构
分层架构
- config.yaml  
配置数据库相关设置。
- main.py  
controller层，管理网络映射。
- Service.py  
service层，服务相关功能。
- Mapper.py
mapper层，对数据进行持久化。
- model.py  
定义数据结构，进行数据校验。

## 具体说明
该应用启动之后，在'/doc'下可查看自动生成文档。
### 数据结构
定义基础四种执行方法，定义请求的字段和数据库中表的映射。  
大部分字段都是并不强制需要的，这样controller可以复用同一个数据检验模型。  
1. 枚举类  
限制字符串的正确性，同时定义字符串之间的映射关系。  
2. 校验类  
method为主要强制需要，代表进行“增删改查”的方式。  
cate代表种类。
### controller
controller分为商品、订单、搜索、二维码相关。  
为了灵活性，除了二维码相关是get请求，其余都是post请求。  
controller层的代码尽可能简单，主要对请求进行筛选和简单校验。
1. 商品  
每一类商品都有对应的controller，可认为摄影师也是一类商品。  
1. 订单
订单分为订单和订单明细，设计可参考超市小票。  
订单中会去记录时间信息，订单明细会记录具体的商品信息。
1. 搜索  
搜索有2种功能：
   - 输入商品，返回商品的可用时间。这里还会具体返回时间区间内，被占用的时间所属的订单。
   - 输入时间，返回可用的商品。这里会返回选择类型下的可用商品。
1. 二维码  
扫描二维码，展示相关商品的信息。  
二维码有3种功能：
   - 返回二维码图片。即，将url编码为qrcode。
   - 根据请求，返回商品的基本信息。
   - 根据上一步的请求，其中有picture_list字段，获取相关图片信息。
1. 上传
上传商品图片，将相关信息保存到数据库和本地文件系统中。
### service
- 基本关系：
  - 首先，需要有商品，才能对于商品进行后续操作。
  - 其次，操作订单，将商品添加到订单中。
  - 最后，搜索已有商品和订单，进行关系管理。  
- 总体流程：
  - 确定时间下订单。
  - 给订单添加商品，即商品明细。需要搜索可用的商品才可以添加。
1. 商品  
直接将controller的请求转移到mapper。
1. 订单  
订单同商品，直接将controller的请求转移到mapper。  
订单明细会使用搜索功能，同时需要反向查找得到另一订单的时间。
1. 搜索  
本项目主要算法相关的部分。  
   - 前提条件  
   摄影师订单之间不需要时间间隔，而商品之间需要，具体设置可以在get_padding中进行设置。
   - 按商品搜索  
   以字典返回一段时间的情况。根据查询，填入每天的情况。
   - 按日期搜索
   需要中间转换步骤。搜索需要向外扩大，才能保证商品虽然不在订单时间内但是在4天间隔内。  
   获取剩余的可用的商品，首先需要统计已使用的商品的情况。  
1. 二维码  
相关的图片会保存在项目同目录下的picture文件夹下。  
二维码的编码由qrcode实现，这里使用默认设置，可以进一步详细设置。  
1. 图片  
会将图片保存到本地文件系统，同时将图片的相关信息保存在数据库中。  
二维码相关功能通过数据库查找到图片。
### mapper
直接使用pymysql进行数据库的链接。
- 数据库相关操作都是原生sql。python中会很方便。
- 数据表名称使用枚举类，这部分字符串不会出现问题。
- 搜索功能中有一个search的函数提供了主要的搜索功能。
### 数据库
数据库中仅订单和订单明细存在键的关联关系，商品之间后续根据条件进行关联。
## 注意事项
- 日期相关的操作，靠近前端的是string，靠近后端的是datetime.date。
- service中，结构体为参数的方式是解耦合的，自定义参数是额外添加的。
- 数据和类都是驼峰命名法，仅函数是下划线命名法。

